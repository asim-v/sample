var NewAccountController=Class.create({ajaxDelayTimer:null,haveSetPromoProductCode:!1,lastPromoCode:!1,userChangedTimeZone:!1,initialize:function(){$("promo_code_field")&&Event.observe($("promo_code_field"),"change",this.updatePriceDelayed.bind(this)),$$("input[type=radio][name=idsubscription_option]").each(function(e){Event.observe(e,"change",this.updatePriceDelayed.bind(this)),Event.observe(e,"click",this.updatePriceDelayed.bind(this))}.bind(this)),$("subscriptionTotal")&&this.updatePriceDelayed(),$("time_zone_field")&&$("address_country_code_field")&&(Event.observe($("time_zone_field"),"change",function(){this.userChangedTimeZone=!0}.bind(this)),$("address_country_code_field").selectize?jQuery("#address_country_code_field").on("change",function(){this.updateTimezoneDefault()}.bind(this)):Event.observe($("address_country_code_field"),"change",this.updateTimezoneDefault.bind(this)),this.updateTimezoneDefault()),$("use_reason_field")&&(this.updateUseReason(),Event.observe($("use_reason_field"),"change",this.updateUseReason.bind(this))),$("subscription_form").observe("submit",function(){$(this).addClassName("submitted")}),$$("#card_expiry_month_field, #card_expiry_year_field").each(function(e){Event.observe(e,"change",this.validateCardExpiry.bind(this))}.bind(this))},validateCardExpiry:function(e){return cardExpiryMonth=$("card_expiry_month_field").getValue(),1===cardExpiryMonth.length&&(cardExpiryMonth="0"+cardExpiryMonth),cardExpiryYear=$("card_expiry_year_field").getValue(),cardExpiry=cardExpiryYear+"-"+cardExpiryMonth,monthRegex=/[0-9]{4,4}-[0-9]{2,2}/,cardExpiry.match(monthRegex)?(renewalMonth=$("subscriptionExplanation").getAttribute("data-subscription_renewal_month"),renewalMonth&&renewalMonth.match&&cardExpiry.match(monthRegex)?void(renewalMonth>cardExpiry?$("card-expiry-warning").show():$("card-expiry-warning").hide()):void $("card-expiry-warning").hide()):void $("card-expiry-warning").hide()},updatePriceDelayed:function(e){$("subscriptionTotal").innerHTML="—",$("promo_message").innerHTML="",$$(".promo_recurring_note").each(function(e){e.hide()}),$$(".promo_free_recurring_note").each(function(e){e.hide()}),null!==this.ajaxDelayTimer&&clearTimeout(this.ajaxDelayTimer),this.ajaxDelayTimer=setTimeout(function(){0==Ajax.activeRequestCount?this.updatePrice():this.updatePriceDelayed()}.bind(this),200)},updatePrice:function(){$("subscriptionTotal").innerHTML="—",$("promo_message").innerHTML="",$("subscriptionTotal").dataset.price=null,$("subscriptionTotal").dataset.recurringPrice=null;var e=$("subscription_form").serialize(!0);e.allow_force_product=this.haveSetPromoProductCode?this.lastPromoCode!=e.promo_code?"1":"0":"1",new Ajax.Request("newaccount.getPrice",{method:"post",parameters:e,onSuccess:function(e){""!=e.responseText&&this._updatePriceCallback(e.responseText.evalJSON(!0))}.bind(this)})},_updatePriceCallback:function(e){if($("payment_method_row").show(),null===e.price?$("subscriptionTotal").innerHTML="—":0==e.price?($("subscriptionTotal").innerHTML="Free",null!==e.recurring_price&&0!=e.recurring_price||($("payment_method_row").hide(),$("payment_method_field_0").checked=!0,$("payment_method_field_0").fire("custom:change"))):$("subscriptionTotal").innerHTML=e.price,$("subscriptionTotal").dataset.price=e.price,$("subscriptionTotal").dataset.recurringPrice=e.recurring_price,$("subscriptionTotal").dataset.subscriptionName=e.subscription_name,e.promo_applied&&e.recurring){var i=null!==e.price&&0==e.price?"promo_free_recurring_note":"promo_recurring_note";$$("."+i).each(function(e){e.show()})}e.promo_attempted?$$(".get-promo-result").each(function(i){i.addClassName(e.promo_applied?"promo-success":"promo-failure"),i.removeClassName(e.promo_applied?"promo-failure":"promo-success")}):$$(".get-promo-result").each(function(e){e.removeClassName("promo-failure"),e.removeClassName("promo-success")}),null!==e.recurring_price&&e.recurring_price!=e.price?($("subscriptionRecurringTotal").innerHTML=e.recurring_price,$("subscriptionRecurringTotalNote").show()):$("subscriptionRecurringTotalNote").hide(),$("subscriptionExplanation")&&(null!==e.subscription_explanation&&e.subscription_explanation!=e.price?($("subscriptionExplanation").innerHTML=e.subscription_explanation,$("subscriptionExplanation").show()):$("subscriptionExplanation").hide(),$("subscriptionExplanation").setAttribute("data-subscription_renewal_month",null!==e.subscription_renewal_month?e.subscription_renewal_month:""),$$(".renewal-month-human").each(function(i){i.innerHTML=null!==e.subscription_renewal_month_human?e.subscription_renewal_month_human:""}),this.validateCardExpiry(!1)),$$(".get-subscription-name").each(function(i){e.subscription_name?(i.innerText=e.subscription_name,i.removeClassName("unavailable")):(i.innerText="",i.addClassName("unavailable"))}),$$(".get-subscription-result").each(function(i){e.subscription_name?i.removeClassName("unavailable"):i.addClassName("unavailable")}),$$(".get-monthly-price").each(function(i){i.innerText=e.monthly_price?e.monthly_price:""}),$$(".get-monthly-price-result").each(function(i){e.monthly_price?i.removeClassName("unavailable"):i.addClassName("unavailable")}),$("promo_message").innerHTML=e.notes,e.promocode!=this.lastPromoCode&&(this.lastPromoCode=e.promocode,this.haveSetPromoProductCode=!1),e.force_product_id&&(el=$("subscription_option_field_"+e.force_product_id),el&&(el.checked=!0),$("nonrecurring_idsubscription_option_field")&&($("nonrecurring_idsubscription_option_field").selectize.addItem(e.force_nonrecurring_idsubscription_option),setTimeout(function(){$("idsubscription_option_field").selectize.addItem(e.force_product_id,!1)}.bind(this),100)),this.haveSetPromoProductCode=!0),$("next-recurring-note")&&(e.promo_applied?$("next-recurring-note").hide():$("next-recurring-note").show()),jQuery&&!function(i){i("#subscription_form").trigger("price-updated",e)}(jQuery)},updateUseReason:function(){"Other"==$("use_reason_field").value?$("use_reason_other").show():$("use_reason_other").hide()},updateTimezoneDefault:function(){if(!this.userChangedTimeZone){var e={offset:this.getBrowserOffset(),country_code:$("address_country_code_field").value};new Ajax.Request("newaccount.getTimeZone",{method:"post",parameters:e,onSuccess:function(e){""!=e.responseText&&this._updateTimezoneDefaultCallback(e.responseText.evalJSON(!0))}.bind(this)})}},_updateTimezoneDefaultCallback:function(e){this.userChangedTimeZone||0!=e.identifier&&($("time_zone_field").value=e.identifier)},getBrowserOffset:function(){var e=new Date,i=e.getTimezoneOffset();return null!==i?60*-i:0}}),newAccountController=null;document.observe("dom:loaded",function(){newAccountController=new NewAccountController});
var Validator=Class.create();Validator.prototype={initialize:function(t,e,i,a){"function"==typeof i?(this.options=$H(a),this._test=i):(this.options=$H(i),this._test=function(){return!0}),this.error=e||"Validation failed.",this.className=t},test:function(t,e){return this._test(t,e)&&this.options.all(function(i){return!Validator.methods[i.key]||Validator.methods[i.key](t,e,i.value)})}},Validator.methods={pattern:function(t,e,i){return Validation.get("IsEmpty").test(t)||i.test(t)},minLength:function(t,e,i){return t.length>=i},maxLength:function(t,e,i){return t.length<=i},min:function(t,e,i){return t>=parseFloat(i)},max:function(t,e,i){return t<=parseFloat(i)},notOneOf:function(t,e,i){return $A(i).all(function(e){return t!==e})},oneOf:function(t,e,i){return $A(i).any(function(e){return t===e})},is:function(t,e,i){return t===i},isNot:function(t,e,i){return t!==i},equalToField:function(t,e,i){return t===$F(i)},notEqualToField:function(t,e,i){return t!==$F(i)},include:function(t,e,i){return $A(i).all(function(i){return Validation.get(i).test(t,e)})}};var Validation=Class.create();Validation.prototype={initialize:function(t,e){if(this.options=Object.extend({onSubmit:!0,stopOnFirst:!1,immediate:!1,focusOnError:!0,useTitles:!1,onFormValidate:function(t,e){},onElementValidate:function(t,e){}},e||{}),this.form=$(t),this.options.onSubmit&&Event.observe(this.form,"submit",this.onSubmit.bind(this),!1),this.options.immediate){var i=this.options.useTitles,a=this.options.onElementValidate;Form.getElements(this.form).each(function(t){Event.observe(t,"blur",function(t){Validation.validate(Event.element(t),{useTitle:i,onElementValidate:a})})})}},onSubmit:function(t){this.validate()||Event.stop(t)},validate:function(){var t=!1,e=this.options.useTitles,i=this.options.onElementValidate;return t=this.options.stopOnFirst?Form.getElements(this.form).all(function(t){return Validation.validate(t,{useTitle:e,onElementValidate:i})}):Form.getElements(this.form).collect(function(t){return Validation.validate(t,{useTitle:e,onElementValidate:i})}).all(),!t&&this.options.focusOnError&&Form.getElements(this.form).findAll(function(t){return $(t).hasClassName("validation-failed")}).first().focus(),this.options.onFormValidate(t,this.form),t},reset:function(){Form.getElements(this.form).each(Validation.reset)}},Object.extend(Validation,{validate:function(t,e){e=Object.extend({useTitle:!1,onElementValidate:function(t,e){}},e||{}),t=$(t);var i=t.classNames(),a=i.all(function(i){var a=Validation.test(i,t,e.useTitle);return e.onElementValidate(a,t),a});return a},test:function(t,e,i){var a=Validation.get(t),n="__advice"+t.camelize();try{if(Validation.isVisible(e)&&!a.test($F(e),e)){if(!e[n]){var o=Validation.getAdvice(t,e);if(null===o){var r=i&&e&&e.title?e.title:a.error;switch(o='<div class="validation-advice" id="advice-'+t+"-"+Validation.getElmID(e)+'" style="display:none">'+r+"</div>",e.type.toLowerCase()){case"checkbox":case"radio":var s=e.parentNode;s?new Insertion.Bottom(s,o):new Insertion.After(e,o);break;default:new Insertion.After(e,o)}o=Validation.getAdvice(t,e)}"undefined"==typeof Effect?o.show():new Effect.Appear(o,{duration:1})}return e[n]=!0,e.removeClassName("validation-passed"),e.addClassName("validation-failed"),!1}var o=Validation.getAdvice(t,e);return null!=o&&o.hide(),e[n]="",e.removeClassName("validation-failed"),e.addClassName("validation-passed"),!0}catch(l){throw l}},isVisible:function(t){for(;"BODY"!=t.tagName;){if(!$(t).visible())return!1;t=t.parentNode}return!0},getAdvice:function(t,e){return $("advice-"+t+"-"+Validation.getElmID(e))||$("advice-"+Validation.getElmID(e))},getElmID:function(t){return t.id?t.id:t.name},reset:function(t){t=$(t);var e=t.classNames();e.each(function(e){var i="__advice"+e.camelize();if(t[i]){var a=Validation.getAdvice(e,t);a.hide(),t[i]=""}t.removeClassName("validation-failed"),t.removeClassName("validation-passed")})},add:function(t,e,i,a){var n={};n[t]=new Validator(t,e,i,a),Object.extend(Validation.methods,n)},addAllThese:function(t){var e={};$A(t).each(function(t){e[t[0]]=new Validator(t[0],t[1],t[2],t.length>3?t[3]:{})}),Object.extend(Validation.methods,e)},get:function(t){return Validation.methods[t]?Validation.methods[t]:Validation.methods._LikeNoIDIEverSaw_},methods:{_LikeNoIDIEverSaw_:new Validator("_LikeNoIDIEverSaw_","",{})}}),Validation.add("IsEmpty","",function(t){return null==t||0==t.length}),Validation.addAllThese([["required","This is a required field.",function(t){return!Validation.get("IsEmpty").test(t)}],["validate-number","Please enter a valid number in this field.",function(t){return Validation.get("IsEmpty").test(t)||!isNaN(t)&&!/^\s+$/.test(t)}],["validate-digits","Please use numbers only in this field. please avoid spaces or other characters such as dots or commas.",function(t){return Validation.get("IsEmpty").test(t)||!/[^\d]/.test(t)}],["validate-alpha","Please use letters only (a-z) in this field.",function(t){return Validation.get("IsEmpty").test(t)||/^[a-zA-Z]+$/.test(t)}],["validate-alphanum","Please use only letters (a-z) or numbers (0-9) only in this field. No spaces or other characters are allowed.",function(t){return Validation.get("IsEmpty").test(t)||!/\W/.test(t)}],["validate-date","Please enter a valid date.",function(t){if(Validation.get("IsEmpty").test(t))return!0;var e=/^(\d{2})\/(\d{2})\/(\d{4})$/;if(!e.test(t))return!1;var i=new Date(t);return parseInt(RegExp.$2,10)==1+i.getMonth()&&parseInt(RegExp.$1,10)==i.getDate()&&parseInt(RegExp.$3,10)==i.getFullYear()}],["validate-email","Please enter a valid email address. For example fred@domain.com.",function(t){return Validation.get("IsEmpty").test(t)||/\w{1,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/.test(t)}],["validate-url","Please enter a valid URL.",function(t){return Validation.get("IsEmpty").test(t)||/^(http|https|ftp):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i.test(t)}],["validate-date-au","Please use this date format: dd/mm/yyyy. For example 17/03/2006 for the 17th of March, 2006.",function(t){if(Validation.get("IsEmpty").test(t))return!0;var e=/^(\d{2})\/(\d{2})\/(\d{4})$/;if(!e.test(t))return!1;var i=new Date(t.replace(e,"$2/$1/$3"));return parseInt(RegExp.$2,10)==1+i.getMonth()&&parseInt(RegExp.$1,10)==i.getDate()&&parseInt(RegExp.$3,10)==i.getFullYear()}],["validate-currency-dollar","Please enter a valid $ amount. For example $100.00 .",function(t){return Validation.get("IsEmpty").test(t)||/^\$?\-?([1-9]{1}[0-9]{0,2}(\,[0-9]{3})*(\.[0-9]{0,2})?|[1-9]{1}\d*(\.[0-9]{0,2})?|0(\.[0-9]{0,2})?|(\.[0-9]{1,2})?)$/.test(t)}],["validate-selection","Please make a selection",function(t,e){return e.options?e.selectedIndex>0:!Validation.get("IsEmpty").test(t)}],["validate-one-required","Please select one of the above options.",function(t,e){var i=e.parentNode,a=i.getElementsByTagName("INPUT");return $A(a).any(function(t){return $F(t)})}]]);
var PaymentMethodController=Class.create({initialize:function(){$$("input[name='payment_method']").each(function(t){Event.observe(t,"change",Function.delay.bind(this.updatePaymentDetialsVisibility.bind(this),.05)),Event.observe(t,"custom:change",Function.delay.bind(this.updatePaymentDetialsVisibility.bind(this),.05)),Event.observe(t,"click",Function.delay.bind(this.updatePaymentDetialsVisibility.bind(this),.05))}.bind(this)),this.updatePaymentDetialsVisibility()},updatePaymentDetialsVisibility:function(){if($("payment_method_field_0")){var t=$RF("payment_method_field_0");$$(" .payment-method-specific").each(function(t,i){i.hasClassName("payment-method-"+t)?this.formSectionDisplay(i,!0):this.formSectionDisplay(i,!1)}.bind(this,t))}},formSectionDisplay:function(t,i){i?t.show():t.hide()}}),paymentMethodController=null;document.observe("dom:loaded",function(){paymentMethodController=new PaymentMethodController});
jQuery.fn.extend({hiddenNotRequired:function(e){setTimeout(function(){var e=this.find("input","select","textarea");e.filter(":hidden").filter(function(){return 1==jQuery(this).prop("required")}).data("required-if-visible",!0).prop("required",!1),e.not(":hidden").filter(function(){return 1==jQuery(this).data("required-if-visible")}).prop("required",!0)}.bind(this),100)}});
document.docReady(function(e){!function(e){if("undefined"!=typeof app){e("#subscription_form").hiddenNotRequired(),e('[data-toggle="tooltip"]').tooltip(),e("#subscription_form").on("submit",function(){e(this).addClass("submitted")}),e("#first_name_field").on("input",function(){e("#card_first_name_field").data("changed")||e("#card_first_name_field").val(e(this).val())}),e("#card_first_name_field").on("change",function(){e(this).data("changed",!0)}),e("#last_name_field").on("input",function(){e("#card_last_name_field").data("changed")||e("#card_last_name_field").val(e(this).val())}),e("#card_last_name_field").on("change",function(){e(this).data("changed",!0)}),e(".promo-add-link").click(function(i){e(".promo-code").addClass("use-promo")}),e(".promo-apply-link").click(function(i){return""==e("#promo_code_field").val()?void e(".promo-code").removeClass("use-promo"):(newAccountController.updatePriceDelayed(),void e(this).addClass("applied"))}),e("#promo_code_field").on("input",function(i){e(".promo-apply-link").removeClass("applied"),e(".promo-result-icon").removeClass("promo-success").removeClass("promo-failure")}),e(".promo-result-icon").click(function(){e("#promo_code_field").focus()}),e("#nonrecurring_idsubscription_option_field").selectize({valueField:"id",labelField:"name",options:app.split_select_period_options,items:[app.nonrecurring_idsubscription_option],onChange:function(i){var n=this.options[i];slave=e("#idsubscription_option_field")[0].selectize,slave.pushOptions(n.subscriptionOptions)}});var i=function(e,i){return'<div class="subscription-option"><span class="name">'+i(e.name)+'</span><span class="price">($'+i(e.price)+")</span></div>"};e("#idsubscription_option_field").selectize({valueField:"id",labelField:"name",options:app.split_select_recurrence_options,items:[app.idsubscription_option],onChange:function(e){newAccountController.updatePriceDelayed()},render:{option:i,item:i}});var n=e("#idsubscription_option_field")[0].selectize;n.pushOptions=function(e){prevValue=this.getValue(),prevItem=null!==prevValue&&this.options&&this.options[prevValue]?this.options[prevValue]:null,prevRecurring=!prevItem||prevItem.recurring,selectItem=_.first(_.sortBy(e,[function(e){return e.recurring!==prevRecurring}])),this.clear(),this.clearOptions(),this.load(function(i){i(e),this.addItem(selectItem.id,!0)})}.bind(n),e("select").not(e(".selectized")).selectize({}),e("#card_expiry_month_field, #card_expiry_year_field").on("change",function(){newAccountController.validateCardExpiry()}),e("#address_country_code_field").on("change",function(){newAccountController.updateTimezoneDefault()}),e("#address_country_code_field").on("change",function(){clientVatIdentificationNumberController.updateVatIdentificationNumberVisibility()}),e("#use_reason_field").on("change",function(){newAccountController.updateUseReason()}),e(".payment-method input[type=radio]").change(function(){e("label.payment-method").removeClass("checked"),e(this).prop("checked")&&e(this).closest("label").addClass("checked"),e("#subscription_form").hiddenNotRequired()}),e("#subscription_form").on("price-updated",function(i,n){e(this).hiddenNotRequired()}),e("#subscription_form").on("change input",":input",_.debounce(function(){e.post("newaccount.save-progress",e("#subscription_form :input").not(function(){return this.name.match(/^card_/)}).serialize())},500))}}(jQuery)});
document.docReady(function(e){!function(e){var a=e("#card_number_field").closest("form");e("#submit_button_field");a.data("cardinal-ready",!1),e("#card_number_field").change(function(){a.data("cardinal-ready",!1)});var t=function(e,a){e.data("cardinal-ready",!1),e.removeClass("submitted"),a||(a="Could not authorize transaction with 3-D Secure. Please try again or try another payment card or method."),QRStuff.notify({dialogId:"3ds-error",messageHtml:'<h2>Payment Error</h2><p style="max-width: 535px;">'+jQuery("<div />").text(a).html()+"</p>",closeButtonText:"ok"})},r=function(a,t){e("#cardinal-cruise-response-jwt").val(t),a.data("cardinal-ready",!0),a.submit()},n=function(a,t){e.ajax({url:"/cardinalcruise.clientresponse",method:"POST",data:{cardinal_cruise_response_data:a,cardinal_cruise_response_jwt:t}})},d=function(e,a,n){return a.Payment&&a.Payment.ExtendedData&&a.Payment.ExtendedData.Enrolled&&"Y"===a.Payment.ExtendedData.Enrolled?a.Payment&&a.Payment.ExtendedData&&a.Payment.ExtendedData.SignatureVerification&&"N"!==a.Payment.ExtendedData.SignatureVerification&&a.Payment&&a.Payment.ExtendedData&&a.Payment.ExtendedData.PAResStatus&&"N"!==a.Payment.ExtendedData.PAResStatus?r(e,n):t(e):r(e,n)};Cardinal.configure({logging:{level:"on"}}),Cardinal.setup("init",{jwt:e("#cardinal-cruise-request-jwt").data("token")}),Cardinal.on("payments.validated",function(i,o){switch(n(i,o),e("#cardinal-cruise-response-jwt").val(""),i.ActionCode){case"SUCCESS":case"NOACTION":d(a,i,o);break;case"FAILURE":t(a);break;case"ERROR":"undefined"==typeof o?r(a,"ERROR: "+JSON.stringify(i)):t(a)}}),a.on("submit",function(t){if("object"==typeof window.subscriptionFormLegacyValidator&&!window.subscriptionFormLegacyValidator.validate())return a.removeClass("submitted"),void t.preventDefault();if(!a.data("cardinal-ready")){var r=_.mapValues(_.keyBy(a.serializeArray(),"name"),"value");if("paypal_direct_payment"===r.payment_method){if("Discover"===r.card_type)return void e("#cardinal-cruise-response-jwt").val(r.card_type);t.preventDefault();var n={Consumer:{Account:{AccountNumber:r.card_number.replace(/\D/g,""),ExpirationMonth:r.card_expiry_month,ExpirationYear:r.card_expiry_year,CardCode:r.card_security_code,NameOnAccount:r.card_first_name+" "+r.card_last_name}},OrderDetails:{Amount:null===e("#subscriptionTotal").data("price")?null:Math.round(100*e("#subscriptionTotal").data("price")),CurrencyCode:"USD",OrderDescription:e("#subscriptionTotal").data("subscriptionName"),OrderChannel:"S"}};"undefined"!=typeof r.first_name&&(n.BillingAddress={FirstName:r.first_name,LastName:r.last_name,Address1:r.address_street,City:r.address_city,State:r.address_state,PostalCode:r.address_postcode,CountryCode:r.address_country_code,Phone1:r.phone_number}),Cardinal.start("cca",n)}}})}(jQuery)});